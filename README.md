# Лабораторная работа 5: Система мониторинга температурных данных

Система для сбора, анализа и визуализации температурных данных с поддержкой различных источников и хранилищ, веб-интерфейсом и REST API.

## Архитектура системы

Система построена на основе клиент-серверной архитектуры:

- **Бэкенд (сервис)** - обработка и хранение данных, API
- **Фронтенд (UI)** - веб-интерфейс для визуализации данных

Общие компоненты:
- **common** - базовые утилиты (умные указатели, логирование, исключения)
- **ipc** - межпроцессное взаимодействие (последовательный порт, базы данных)
- **rpc** - HTTP сервер и обработчики запросов
- **service** - основная логика бэкенда
- **ui** - веб-интерфейс

## Сборка и запуск

```bash
# Сборка проекта
mkdir build && cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
cmake --build .

# Запуск бэкенда
./service -c config.json

# Запуск фронтенда
./ui -c ui_config.json

# Ускорение процесса для тестирования
./service -c config.json -a 60.0
```

## Основные возможности

- **Разделение фронтенда и бэкенда**
  - Независимое масштабирование компонентов
  - Возможность запуска на разных машинах

- **Хранение данных**:
  - Файловое хранилище
  - PostgreSQL с автоматической ротацией данных

- **Обработка данных**:
  - Чтение с последовательного порта (кросс-платформенный код)
  - Автоматическая агрегация:
    - Сырые данные: хранение 24 часа
    - Часовые средние: хранение 30 дней
    - Дневные средние: хранение 365 дней

- **Доступ к данным**:
  - Веб-интерфейс
  - REST API

## Конфигурация

### Бэкенд (config.json)

```json
{
    "serial": {
        "serial_port": "/dev/ttyUSB0",
        "baud_rate": 115200,
        "format": "text"
    },
    "storage": {
        "db_client": {
            "host_address": "127.0.0.1",
            "port": 5432,
            "db_name": "temperature",
            "user_name": "monitoring",
            "password_env": "DB_PASS"
        }
    },
    "logging": [
        {
            "path": "logs/app.log",
            "level": "Info"
        },
        {
            "path": "logs/debug.log",
            "level": "Debug"
        }
    ],
    "mesure_delay": 150,
    "port": 8081
}
```

### Фронтенд (ui_config.json)

```json
{
    "service_endpoint": "http://localhost:8081",
    "port": 8080,
    "assets_path": "./assets",
    "logging": [
        {
            "path": "logs/ui.log",
            "level": "Info"
        }
    ]
}
```

### Симулятор (simulator_config.json)

```json
{
    "serial": {
        "serial_port": "COM3",
        "baud_rate": 9600,
        "format": "text"
    },
    "time_multiplier": 60.0,
    "delay_ms": 100
}
```

## Симулятор данных

Для тестирования системы без реального датчика используйте симулятор температурных данных:

```bash
# С конфигурационным файлом
./simulator -c simulator_config.json

# С параметрами командной строки
./simulator -p /dev/ttyUSB0 -b 115200 -m 60.0

# Ускоренная симуляция (1 год за 6 часов)
./simulator -c simulator_config.json -m 1460
```

Параметры симулятора:
- `-c/--config` - путь к файлу конфигурации
- `-p/--port` - путь к последовательному порту (COM3, /dev/ttyUSB0)
- `-b/--baud` - скорость порта (9600, 115200)
- `-m/--multiplier` - множитель времени (для ускорения симуляции)

## Форматы данных для последовательного порта

Система поддерживает несколько форматов данных для передачи температуры через последовательный порт:

1. **text** (по умолчанию) - Текстовый формат, температура передается как ASCII строка с десятичным числом.
   Пример: `23.5`

2. **byte_integer** - 1-байтовый целочисленный двоичный формат. 
   Температура передается как одно целое число в диапазоне от -127 до 128.
   Подходит для простых датчиков с низкой точностью.

3. **fixed_point** - 2-байтовый формат с фиксированной точкой (точность 0.1°C).
   Температура передается как 16-битное целое число, умноженное на 10.
   Подходит для передачи температур от -3276.8°C до 3276.7°C с точностью 0.1°C.

4. **floating_point** - 4-байтовый формат IEEE754 с плавающей точкой.
   Температура передается как 32-битное число с плавающей точкой.
   Обеспечивает наибольшую точность и диапазон.

### Формат данных
- Метка времени: ISO 8601 формат (YYYY-MM-DDTHH:MM:SSZ)
- Значение температуры: числовое, с плавающей точкой

### Файловое хранилище
```json
{
    "storage": {
        "file_system": {
            "temperature": "data/current.log",
            "hourly": "data/hourly_avg.log",
            "daily": "data/daily_avg.log"
        }
    }
}
```

### PostgreSQL
```json
{
    "storage": {
        "db_client": {
            "host_address": "127.0.0.1",
            "port": 5432,
            "db_name": "temperature",
            "user_name": "monitoring",
            "password_env": "DB_PASS"
        }
    }
}
```

## API endpoints

- `GET /list/raw` - получение сырых показаний температуры
- `GET /list/hour` - получение часовых средних значений
- `GET /list/day` - получение дневных средних значений

## Проверка работы

1. Запустите бэкенд: `./service -c config.json`
2. Запустите фронтенд: `./ui -c ui_config.json` 
3. Запустите симулятор: `./simulator -p /dev/ttyUSB0 -b 115200`
4. Откройте веб-интерфейс: `http://localhost:8080/`
5. Проверьте API: `curl http://localhost:8081/list/raw`

## Технические особенности

- Кросс-платформенная поддержка (Windows, Linux)
- Система интрузивных умных указателей с подсчетом ссылок
- Поддержка разных форматов входных данных
- Многопоточная обработка запросов
- Шаблонизация через Jinja2
- Потокобезопасное хранение и обновление данных
- Обработка исключений и гибкая система логирования
