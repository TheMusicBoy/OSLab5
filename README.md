# Лабораторная работа 5: Система мониторинга температурных данных

Система для сбора, анализа и визуализации температурных данных с поддержкой различных источников и хранилищ, веб-интерфейсом и REST API.

## Архитектура системы

Система построена на основе компонентной архитектуры с интрузивными указателями для управления памятью:

- Модуль `common` - базовые компоненты (умные указатели, логирование, исключения)
- Модуль `ipc` - межпроцессное взаимодействие (последовательный порт, базы данных)
- Модуль `rpc` - HTTP сервер и обработчики запросов
- Модуль `service` - основная логика сервиса

## Сборка и запуск

```bash
# Сборка проекта
mkdir build && cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
cmake --build .

# Запуск основной службы с конфигурацией
./main -c config.json

# Ускорение процесса (для тестирования)
./main -c config.json -a 60.0
```

## Основные возможности

- Поддержка различных типов хранилищ:
  - Файловое хранилище
  - PostgreSQL с автоматической ротацией данных
- Чтение данных с последовательного порта (кросс-платформенный код)
- Автоматическая агрегация и очистка данных:
  - Сырые данные: хранение 24 часа
  - Часовые средние: хранение 30 дней
  - Дневные средние: хранение 365 дней
- Веб-интерфейс для визуализации данных
- REST API для программного доступа
- Шаблонизация через Jinja2
- Управление статическими ресурсами с автоматической перезагрузкой
- Многопоточная обработка запросов
- Гибкая система логирования

## Конфигурация

### PostgreSQL (config.json)

```json
{
    "serial": {
        "serial_port": "/dev/ttyUSB0",
        "baud_rate": 115200
    },
    "storage": {
        "db_client": {
            "host_address": "127.0.0.1",
            "port": 5432,
            "db_name": "temperature",
            "user_name": "monitoring",
            "password_env": "DB_PASS"
        }
    },
    "logging": [
        {
            "path": "logs/app.log",
            "level": "Info"
        },
        {
            "path": "logs/debug.log",
            "level": "Debug"
        }
    ],
    "mesure_delay": 150,
    "assets_path": "./assets"
}
```

### Файловое хранилище (file_config.json)

```json
{
    "serial": {
        "serial_port": "COM3",
        "baud_rate": 9600
    },
    "storage": {
        "file_system": {
            "temperature": "data/current.log",
            "hourly": "data/hourly_avg.log",
            "daily": "data/daily_avg.log"
        }
    },
    "logging": [
        {
            "path": "logs/app.log",
            "level": "Info"
        }
    ],
    "mesure_delay": 200,
    "assets_path": "./assets"
}
```

## Симулятор данных

Для тестирования системы без реального датчика можно использовать симулятор, который генерирует реалистичные температурные данные.

### Примеры запуска

```bash
# С конфигурационным файлом
./tools/simulator -c simulator_config.json

# С параметрами командной строки
./tools/simulator -p /dev/ttyUSB0 -b 115200 -m 60.0

# Ускоренная симуляция (1 год за 6 часов)
./tools/simulator -c base_config.json -m 1460
```

### Параметры симулятора

```json
{
    "serial": {
        "serial_port": "COM3",
        "baud_rate": 9600
    },
    "time_multiplier": 60.0
}
```

- `-c/--config` - путь к файлу конфигурации
- `-p/--port` - путь к последовательному порту (COM3, /dev/ttyUSB0)
- `-b/--baud` - скорость порта (9600, 115200)
- `-m/--multiplier` - множитель времени (для ускорения симуляции)

## Структура хранимых данных

### Формат данных
- Метка времени: ISO 8601 формат (YYYY-MM-DDTHH:MM:SSZ)
- Значение температуры: числовое, с плавающей точкой

### Файловое хранилище
- Каждая запись в отдельной строке
- Формат: `YYYY-MM-DDTHH:MM:SSZ значение`
- Автоматическая ротация данных по времени

### PostgreSQL
- Автоматическое создание необходимых таблиц
- Индексирование по временной метке
- Автоматическая очистка устаревших данных

## Проверка работы

1. Запустите сервис: `./main -c config.json`
2. Запустите симулятор: `./tools/simulator -p /dev/ttyUSB0 -b 115200`
3. Откройте веб-интерфейс: `http://localhost:8080/`
4. Проверьте API:
```bash
curl http://localhost:8080/list/raw
curl http://localhost:8080/list/hour
curl http://localhost:8080/list/day
```

## Технические особенности

- Кросс-платформенная поддержка (Windows, Linux, macOS)
- Система умных указателей с подсчетом ссылок
- Управление жизненным циклом объектов
- Асинхронная обработка запросов
- Потокобезопасное хранение и обновление данных
- Обработка исключений и логирование ошибок
